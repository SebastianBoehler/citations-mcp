<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Paper List</title>
    <style>
      :root {
        color: #0b0f19;
        font-family: "Inter", "SF Pro Display", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f6fb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        background: #f5f6fb;
        display: flex;
        justify-content: center;
      }

      main {
        width: min(960px, 100%);
        background: #ffffff;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 35px 80px rgba(15, 23, 42, 0.09);
      }

      header {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }

      header h1 {
        font-size: 1.6rem;
        margin: 0;
      }

      #status-pill {
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
      }

      #summary-card {
        border: 1px solid #eceffe;
        border-radius: 16px;
        padding: 16px;
        background: #fafaff;
        margin-bottom: 20px;
      }

      #summary-card h2 {
        margin: 0 0 6px;
        font-size: 1.1rem;
      }

      #summary-card p {
        margin: 2px 0;
        color: #475467;
        font-size: 0.95rem;
      }

      #results {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .paper-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #f8f9ff;
        border: 1px solid #eef2ff;
        border-radius: 12px;
        font-size: 0.95rem;
        color: #374151;
        transition: background-color 150ms ease;
      }

      .paper-item:hover {
        background: #f0f4ff;
      }

      .paper-icon {
        width: 16px;
        height: 16px;
        margin-right: 12px;
        color: #6366f1;
      }

      #empty-state {
        border: 1px dashed #d0d7ff;
        padding: 26px;
        border-radius: 16px;
        text-align: center;
        color: #6b7280;
      }

      #toast {
        margin-top: 8px;
        font-size: 0.85rem;
      }

      #toast[data-variant="error"] {
        color: #b91c1c;
      }

      #toast[data-variant="success"] {
        color: #166534;
      }

      #toast[data-variant="info"] {
        color: #0f172a;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>List Papers</h1>
        <span id="status-pill">Waiting for tool outputâ€¦</span>
      </header>

      <section id="summary-card" aria-live="polite">
        <h2>Papers Summary</h2>
        <p id="summary-text">Waiting for the MCP tool to return paper list.</p>
        <p id="timestamp-text"></p>
      </section>

      <section id="results"></section>
      <div id="empty-state" hidden>
        <p>No papers found.</p>
        <p>Make sure your papers directory contains PDF files.</p>
      </div>
    </main>

    <script type="module">
      const state = {
        payload: null,
        lastUpdated: null,
      };

      const resultsEl = document.getElementById("results");
      const emptyStateEl = document.getElementById("empty-state");
      const summaryTextEl = document.getElementById("summary-text");
      const timestampTextEl = document.getElementById("timestamp-text");
      const statusPillEl = document.getElementById("status-pill");

      const formatTime = (date) =>
        date ? new Intl.DateTimeFormat(undefined, { timeStyle: "medium" }).format(date) : "";

      const coerceStructured = (output) => {
        if (!output) return null;
        if (output.structuredContent) {
          console.debug("[papers-list-widget] structuredContent wrapper detected", output);
          return output.structuredContent;
        }
        if (output.result) {
          console.debug("[papers-list-widget] result wrapper detected", output);
          return coerceStructured(output.result);
        }
        console.debug("[papers-list-widget] raw payload detected", output);
        return output;
      };

      const setStatus = (message) => {
        statusPillEl.textContent = message;
      };

      const updatePayload = (raw) => {
        const structured = coerceStructured(raw);
        if (!structured || typeof structured !== "object") {
          console.warn("[papers-list-widget] payload missing or not an object", structured);
          return;
        }
        console.debug("[papers-list-widget] updating payload", structured);
        state.payload = structured;
        state.lastUpdated = new Date();
        render();
      };

      const render = () => {
        const payload = state.payload;
        summaryTextEl.textContent = payload
          ? payload.error
            ? `Unable to retrieve papers list`
            : `Found ${payload.total_papers ?? 0} paper(s) in the collection`
          : "Waiting for tool output...";

        timestampTextEl.textContent = payload && state.lastUpdated ? `Updated ${formatTime(state.lastUpdated)}` : "";

        if (!payload || payload.error || !payload.papers || payload.papers.length === 0) {
          resultsEl.innerHTML = "";
          emptyStateEl.hidden = false;
          if (payload?.error) {
            console.warn("[papers-list-widget] payload error", payload.error);
          } else {
            console.info("[papers-list-widget] no papers present", payload);
          }
          return;
        }

        emptyStateEl.hidden = true;
        const papers = payload.papers;
        resultsEl.innerHTML = "";
        console.debug("[papers-list-widget] rendering papers", papers);

        papers.forEach((paper) => {
          const item = document.createElement("div");
          item.className = "paper-item";
          
          // Add PDF icon
          const icon = document.createElement("span");
          icon.className = "paper-icon";
          icon.innerHTML = "ðŸ“„";
          
          // Paper filename
          const text = document.createElement("span");
          text.textContent = typeof paper === "string" ? paper : paper.filename || "Unknown file";
          
          item.append(icon, text);
          resultsEl.appendChild(item);
        });
      };

      const initialOutput = window.openai?.toolOutput;
      if (initialOutput) {
        updatePayload(initialOutput);
        setStatus("Showing latest tool response");
      }

      window.addEventListener(
        "openai:set_globals",
        (event) => {
          const globals = event.detail?.globals;
          if (globals?.toolOutput) {
            updatePayload(globals.toolOutput);
            setStatus("Synced with latest tool output");
          }
        },
        { passive: true }
      );

      if (!window.openai) {
        emptyStateEl.hidden = false;
        summaryTextEl.textContent = "window.openai is not available â€“ open inside ChatGPT to view paper list.";
        setStatus("Unsupported host");
      }
    </script>
  </body>
</html>
