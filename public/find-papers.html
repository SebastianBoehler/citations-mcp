<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Paper Search Explorer</title>
    <style>
      :root {
        color: #0b0f19;
        font-family: "Inter", "SF Pro Display", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f6fb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        background: #f5f6fb;
        display: flex;
        justify-content: center;
      }

      main {
        width: min(960px, 100%);
        background: #ffffff;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 35px 80px rgba(15, 23, 42, 0.09);
      }

      header {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }

      header h1 {
        font-size: 1.6rem;
        margin: 0;
      }

      #status-pill {
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
      }

      #summary-card {
        border: 1px solid #eceffe;
        border-radius: 16px;
        padding: 16px;
        background: #fafaff;
        margin-bottom: 20px;
      }

      #summary-card h2 {
        margin: 0 0 6px;
        font-size: 1.1rem;
      }

      #summary-card p {
        margin: 2px 0;
        color: #475467;
        font-size: 0.95rem;
      }

      #results {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .paper-result-card {
        border: 1px solid #e4e7f5;
        border-radius: 18px;
        padding: 20px;
        background: #fff;
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.05);
        transition: transform 200ms ease, box-shadow 200ms ease;
      }

      .paper-result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 16px;
      }

      .paper-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 4px 0;
        line-height: 1.3;
      }

      .paper-authors {
        font-size: 0.9rem;
        color: #64748b;
        margin: 0 0 8px 0;
      }

      .paper-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .score-badge {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
      }

      .content-box {
        background: #f8f9ff;
        border: 1px solid #eef2ff;
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
      }

      .content-text {
        font-size: 0.95rem;
        color: #374151;
        line-height: 1.6;
        margin: 0;
        max-height: 200px;
        overflow-y: auto;
      }

      .content-text::-webkit-scrollbar {
        width: 6px;
      }

      .content-text::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }

      .content-text::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      .content-text::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      #empty-state {
        border: 1px dashed #d0d7ff;
        padding: 26px;
        border-radius: 16px;
        text-align: center;
        color: #6b7280;
      }

      #toast {
        margin-top: 8px;
        font-size: 0.85rem;
      }

      #toast[data-variant="error"] {
        color: #b91c1c;
      }

      #toast[data-variant="success"] {
        color: #166534;
      }

      #toast[data-variant="info"] {
        color: #0f172a;
      }

      @media (max-width: 720px) {
        .result-header {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .paper-meta {
          gap: 8px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Find Papers</h1>
        <span id="status-pill">Waiting for tool output…</span>
      </header>

      <section id="summary-card" aria-live="polite">
        <h2>Search Results Summary</h2>
        <p id="summary-text">Waiting for the MCP tool to return paper search results.</p>
        <p id="timestamp-text"></p>
      </section>

      <section id="results"></section>
      <div id="empty-state" hidden>
        <p>No papers found yet.</p>
        <p>Submit a search query above to populate the widget.</p>
      </div>
    </main>

    <script type="module">
      const state = {
        payload: null,
        lastUpdated: null,
      };

      const resultsEl = document.getElementById("results");
      const emptyStateEl = document.getElementById("empty-state");
      const summaryTextEl = document.getElementById("summary-text");
      const timestampTextEl = document.getElementById("timestamp-text");
      const statusPillEl = document.getElementById("status-pill");

      const formatTime = (date) =>
        date ? new Intl.DateTimeFormat(undefined, { timeStyle: "medium" }).format(date) : "";

      const coerceStructured = (output) => {
        if (!output) return null;
        if (output.structuredContent) {
          console.debug("[papers-widget] structuredContent wrapper detected", output);
          return output.structuredContent;
        }
        if (output.result) {
          console.debug("[papers-widget] result wrapper detected", output);
          return coerceStructured(output.result);
        }
        console.debug("[papers-widget] raw payload detected", output);
        return output;
      };

      const setStatus = (message) => {
        statusPillEl.textContent = message;
      };

      const updatePayload = (raw) => {
        const structured = coerceStructured(raw);
        if (!structured || typeof structured !== "object") {
          console.warn("[papers-widget] payload missing or not an object", structured);
          return;
        }
        console.debug("[papers-widget] updating payload", structured);
        state.payload = structured;
        state.lastUpdated = new Date();
        render();
      };

      const render = () => {
        const payload = state.payload;
        summaryTextEl.textContent = payload
          ? payload.error
            ? `Unable to retrieve papers for "${payload.query ?? ""}"`
            : `Found ${payload.results?.length ?? 0} result(s) for "${payload.query ?? ""}"`
          : "Waiting for tool output...";

        timestampTextEl.textContent = payload && state.lastUpdated ? `Updated ${formatTime(state.lastUpdated)}` : "";

        if (!payload || payload.error || !payload.results || payload.results.length === 0) {
          resultsEl.innerHTML = "";
          emptyStateEl.hidden = false;
          if (payload?.error) {
            console.warn("[papers-widget] payload error", payload.error);
          } else {
            console.info("[papers-widget] no results present", payload);
          }
          return;
        }

        emptyStateEl.hidden = true;
        const results = payload.results;
        resultsEl.innerHTML = "";
        console.debug("[papers-widget] rendering results", results);

        results.forEach((result, index) => {
          const card = document.createElement("article");
          card.className = "paper-result-card";

          const header = document.createElement("div");
          header.className = "result-header";

          const titleInfo = document.createElement("div");
          titleInfo.style.flex = "1";
          
          const title = document.createElement("h3");
          title.className = "paper-title";
          title.textContent = result?.metadata?.paper_title ?? "Unknown Paper";
          
          const authors = document.createElement("div");
          authors.className = "paper-authors";
          authors.textContent = result?.metadata?.paper_authors ?? "Unknown Authors";
          
          const meta = document.createElement("div");
          meta.className = "paper-meta";
          
          const filename = document.createElement("span");
          filename.className = "meta-item";
          filename.innerHTML = `<strong>File:</strong> ${result?.metadata?.filename ?? "Unknown"}`;
          
          const page = document.createElement("span");
          page.className = "meta-item";
          page.innerHTML = `<strong>Page:</strong> ${result?.metadata?.page ?? "?"}`;
          
          const chunkId = document.createElement("span");
          chunkId.className = "meta-item";
          chunkId.innerHTML = `<strong>Chunk:</strong> ${result?.metadata?.chunk_id ?? 0}`;
          
          meta.append(filename, page, chunkId);
          titleInfo.append(title, authors, meta);

          const score = typeof result?.score === "number" ? result.score.toFixed(3) : result?.score;
          const scoreBadge = document.createElement("span");
          scoreBadge.className = "score-badge";
          scoreBadge.textContent = `Score ${score ?? "-"}`;

          header.append(titleInfo, scoreBadge);
          card.appendChild(header);

          const contentBox = document.createElement("div");
          contentBox.className = "content-box";
          
          const content = document.createElement("p");
          content.className = "content-text";
          content.textContent = result?.content ?? "";
          
          contentBox.appendChild(content);
          card.appendChild(contentBox);

          resultsEl.appendChild(card);
        });
      };

      const initialOutput = window.openai?.toolOutput;
      if (initialOutput) {
        updatePayload(initialOutput);
        setStatus("Showing latest tool response");
      }

      window.addEventListener(
        "openai:set_globals",
        (event) => {
          const globals = event.detail?.globals;
          if (globals?.toolOutput) {
            updatePayload(globals.toolOutput);
            setStatus("Synced with latest tool output");
          }
        },
        { passive: true }
      );

      if (!window.openai) {
        emptyStateEl.hidden = false;
        summaryTextEl.textContent = "window.openai is not available – open inside ChatGPT to view paper search results.";
        setStatus("Unsupported host");
      }
    </script>
  </body>
</html>
